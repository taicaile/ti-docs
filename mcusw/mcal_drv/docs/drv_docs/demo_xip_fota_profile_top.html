<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<title>MCUSW: Execute In Place (XIP) + Firmware Over The Air (FOTA) Application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ti_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MCUSW
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('demo_xip_fota_profile_top.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Execute In Place (XIP) + Firmware Over The Air (FOTA) Application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="demo_xip_fota_profile_intro"></a>
Introduction</h1>
<hr/>
<p>This application demonstrates execute-in-place, where in CAN Profiling Application is executed from OSPI memory. i.e. The secondary boot loader, will not fetch the CAN Profiling Application from on-board Flash to RAM. Instead execute it from the on-board memory. In addition to the CAN Profiling Application running in XIP mode, the demo also has a separate task that does firmware update in parallel to application execution. The demo showcases concurrent write while XIP read is in progress for a non RWW Flash. The demo also showcases the state machine logic for interleaving XIP read and New Application write access.</p>
<p>Table below list SoC/Cores on which this demo application is tested </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">SoC  </th><th class="markdownTableHeadNone">Host Core  </th><th class="markdownTableHeadNone">Comments   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">J721E  </td><td class="markdownTableBodyNone">MCU 1 0  </td><td class="markdownTableBodyNone">MCAL could be hosted on other cores but this demo application runs only on MCU 1 0, at this point of time.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">J7200  </td><td class="markdownTableBodyNone">MCU 1 0  </td><td class="markdownTableBodyNone">MCAL could be hosted on other cores but this demo application runs only on MCU 1 0, at this point of time.   </td></tr>
</table>
<p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
<h1><a class="anchor" id="demo_xip_fota_profile_flowchart"></a>
Flow Chart</h1>
<div class="image">
<img src="demo_can_profile_xip_fota_boot_flow.png" alt="demo_can_profile_xip_fota_boot_flow.png"/>
<div class="caption">
CAN Profiling XIP+FOTA Boot Flow</div></div>
 <div class="image">
<img src="demo_can_profile_xip_fota_application_flow.png" alt="demo_can_profile_xip_fota_application_flow.png"/>
<div class="caption">
CAN Profiling XIP+FOTA Application Flow</div></div>
<p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
<h1><a class="anchor" id="demo_xip_fota_profile_demo_cfg"></a>
Compile Time Configurations</h1>
<ol type="1">
<li>APP_NUM_MSG_PER_ITERATION Controls the number of messages that would be sent per iteration</li>
<li>APP_NUM_ITERATION Number of iterations, total can messages sent would be APP_NUM_MSG_PER_ITERATION * APP_NUM_ITERATION</li>
<li>APP_INSTANCE_1_INST_IN_CFG_ONLY Use first instance of CAN peripheral configured</li>
<li>CAN_TX_ONLY_MODE Used to configure in CAN in tx only mode</li>
</ol>
<p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
 <h1><a class="anchor" id="demo_xip_fota_profile_demo_cfg_custom_top"></a>
Customizing Examples Application</h1>
<p>The profiling application is configured to operate in loop-back mode by default. This application can be configured to operate in transmit-only, receive-only or loopback mode.</p>
<p>The below table lists the configuration changes required to change mode. Please ensure to recompile post modifications.</p>
<h2><a class="anchor" id="demo_xip_fota_profile_demo_cfg_custom_tx"></a>
TX Only</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">For TX Only  </th><th class="markdownTableHeadCenter">Flag Value  </th><th class="markdownTableHeadNone">Location   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">APP_INSTANCE_1_INST_IN_CFG_ONLY  </td><td class="markdownTableBodyCenter">STD_ON  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\profiling\can\can_profile.h   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CAN_LOOPBACK_ENABLE  </td><td class="markdownTableBodyCenter">STD_OFF  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\mcal_config\Can_Demo_Cfg\output\generated\soc\j72xx\mcu1_0\include\Can_Cfg.h   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CAN_TX_ONLY_MODE  </td><td class="markdownTableBodyCenter">STD_ON  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\profiling\can\can_profile.h   </td></tr>
</table>
<p>This application would transmit CAN FD messages with extended ID (0xC0) at nominal-rate of 1 Mbps, data-rate at 5 Mbps</p>
<h2><a class="anchor" id="demo_xip_fota_profile_demo_cfg_custom_rx"></a>
RX Only</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">For RX Only  </th><th class="markdownTableHeadCenter">Flag Value  </th><th class="markdownTableHeadNone">Location   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">APP_INSTANCE_1_INST_IN_CFG_ONLY  </td><td class="markdownTableBodyCenter">STD_ON  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\profiling\can\can_profile.h   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CAN_LOOPBACK_ENABLE  </td><td class="markdownTableBodyCenter">STD_OFF  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\mcal_config\Can_Demo_Cfg\output\generated\soc\j72xx\mcu1_0\include\Can_Cfg.h   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CAN_TX_ONLY_MODE  </td><td class="markdownTableBodyCenter">STD_OFF  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\profiling\can\can_profile.h   </td></tr>
</table>
<p>This application setup to receive CAN FD messages with extended ID (0xC0) at nominal-rate of 1 Mbps, data-rate at 5 Mbps</p>
<h2><a class="anchor" id="demo_xip_fota_profile_demo_cfg_custom_lpbk"></a>
Loopback (default)</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">For Internal Loopback (default)  </th><th class="markdownTableHeadCenter">Flag Value  </th><th class="markdownTableHeadNone">Location   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">APP_INSTANCE_1_INST_IN_CFG_ONLY  </td><td class="markdownTableBodyCenter">STD_OFF  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\profiling\can\can_profile.h   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CAN_LOOPBACK_ENABLE  </td><td class="markdownTableBodyCenter">STD_ON  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\mcal_config\Can_Demo_Cfg\output\generated\soc\j72xx\mcu1_0\include\Can_Cfg.h   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CAN_TX_ONLY_MODE  </td><td class="markdownTableBodyCenter">X  </td><td class="markdownTableBodyNone">mcusw\mcuss_demos\profiling\can\can_profile.h   </td></tr>
</table>
<p>No additional connections / setup is required in this mode</p>
<p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
 <h2><a class="anchor" id="demo_xip_fota_profile_build"></a>
Steps to build</h2>
<p>We need to have the following binaries built from <em>pdk</em>:</p><ul>
<li><b>sbl_ospi_img</b> that loads SYSFW, initializes the OSPI flash in execute-in-place (XIP) mode</li>
</ul>
<hr/>
 <h3>Building sbl_ospi_img</h3>
<p>Go to (SDK Install Directory)/pdk_jacinto_07.x.x/packages/ti/build and run the following: </p><pre class="fragment">make sbl_ospi_img BOARD=j72xx_evm
</pre><hr/>
 <h3>Building can_profile_xip_fota_app</h3>
<p>Create a demo directory to store the binaries for this demo. <br />
 Create a subdirectory called "P2_image". <br />
 Go to (SDK Install Directory)/mcusw/build and run the following: <br />
 </p><pre class="fragment">make can_profile_xip_fota_app BUILD_OS_TYPE=tirtos BOARD=j72xx_evm REGION=P1
cp ../binary/can_profile_xip_fota_app/bin/j72xx_evm/can_profile_xip_fota_app_mcu1_0_release.appimage (DEMO DIRECTORY)
cp ../binary/can_profile_xip_fota_app/bin/j72xx_evm/can_profile_xip_fota_app_mcu1_0_release.appimage_xip (DEMO DIRECTORY)
make allclean
make can_profile_xip_fota_app BUILD_OS_TYPE=tirtos BOARD=j72xx_evm REGION=P2
cp ../binary/can_profile_xip_fota_app/bin/j72xx_evm/can_profile_xip_fota_app_mcu1_0_release.appimage (DEMO DIRECTORY)/P2_image/
cp ../binary/can_profile_xip_fota_app/bin/j72xx_evm/can_profile_xip_fota_app_mcu1_0_release.appimage_xip (DEMO DIRECTORY)/P2_image/
mv (DEMO DIRECTORY)/P2_image/can_profile_xip_fota_app_mcu1_0_release.appimage_xip (DEMO DIRECTORY)/P2_image/can_profile_xip_fota_app_mcu1_0_release_xip.appimage
cp ../mcuss_demos/profiling/can_profile_xip_fota_app/bk_region.bin (DEMO DIRECTORY)
</pre><p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
 <h2><a class="anchor" id="demo_xip_fota_profile_flash"></a>
Steps to flash</h2>
<p>Install uniflash 6.3 from <a href="http://www.ti.com/tool/UNIFLASH">http://www.ti.com/tool/UNIFLASH</a></p>
<p><b> Note </b> : Uniflash 6.3 does not support .appimage_xip file. Support for this would be added in Uniflash 6.4. Please follow the below steps after installing Uniflash.</p>
<ul>
<li>cd (SDK Install Directory)/pdk_jacinto_07.x.x/packages/ti/board/utils/uniflash/host/</li>
<li>make all (Linux) or gmake all (Windows)</li>
<li>copy ProcessorSDKSerialFlash (Linux) or ProcessorSDKSerialFlash.exe (Windows) to (Uniflash Install Directory)/processors/</li>
<li>cd (SDK Install Directory)/pdk_jacinto_07.x.x/packages/ti/build/</li>
<li>make board_utils_uart_flash_programmer BOARD=j7xx_evm CORE=mcu1_0 -sj8</li>
<li>copy (SDK Install Directory)/pdk_jacinto_07.x.x/packages/ti/binary uart_j7xx_evm_flash_programmer_release.tiimage to (Uniflash Install Directory)/processors/FlashWriter/j7xx_evm</li>
</ul>
<p>For using OSPI the SW3 switch setting should be : 0XXX_XXXX_XX</p>
<p>Specific SW setting for different boot modes-</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Mode  </th><th class="markdownTableHeadNone">Switch Settings   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">UART  </td><td class="markdownTableBodyNone">SW8: 0000_0000, SW9: 0111_0000   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">OSPI (J721E)  </td><td class="markdownTableBodyNone">SW8: 0000_0000, SW9: 0100_0000   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">OSPI (J7200)  </td><td class="markdownTableBodyNone">SW8: 1000_0010, SW9: 0011_0000   </td></tr>
</table>
<ul>
<li>Change the boot mode to UART boot mode.</li>
<li>Connect to the second instance of UART (/dev/ttyUSB1 in linux, COMxx in Windows) and power on. One should see 'CCC...' being printed on the console. Once validated, note down the instance number and close the instance of the UART (the UART device needs to be free to transfer data)</li>
<li>Navigate to the uniflash installed directory, dslite.sh should be present here.</li>
<li><p class="startli">Run the following commands to flash</p><ol type="1">
<li>UART SBL and sysfw : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (Path to Uniflash Install Directory)/processors/FlashWriter/j72xx_evm/uart_j72xx_evm_flash_programmer_release.tiimage -i 0</li>
<li>OSPI SBL : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (SDK Install Directory)/pdk_jacinto_07.x.x/packages/ti/boot/sbl/binary/j72xx_evm/ospi/bin/sbl_ospi_img_mcu1_0_release.tiimage -d 3 -o 0</li>
<li>tifs.bin : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (SDK Install Directory)/pdk_jacinto_07.x.x/packages/ti/drv/sciclient/soc/Vx/tifs.bin -d 3 -o 80000</li>
<li>FOTA P1 RAM Image : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (Demo Directory)/can_profile_xip_app_mcu1_0_release.appimage -d 3 -o 100000</li>
<li>FOTA P1 XIP Image : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (Demo Directory)/can_profile_xip_app_mcu1_0_release.appimage_xip -d 3</li>
<li>FOTA P2 RAM Image : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (Demo Directory)/P2_image/can_profile_xip_app_mcu1_0_release.appimage -d 3 -o 3000000</li>
<li>FOTA P2 XIP Image : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (Demo Directory)/P2_image/can_profile_xip_app_mcu1_0_release_xip.appimage -d 3 -o 3800000</li>
<li>BK Region Image : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (Demo Directory)/bk_region.bin -d 3 -o 3F00000</li>
<li>OSPI Phy Tuning Bin : ./dslite.sh &ndash;mode processors -c /dev/ttyUSB1 -f (SDK Install Directory)/pdk/packages/ti/board/src/flash/nor/ospi/nor_spi_patterns.bin -d 3 -o 3FC0000</li>
</ol>
<p class="startli">Power off the board and change the bootmode to OSPI. Connect to second instance of UART and Power on the board. You should see the logs on the MCU uart console</p>
<p class="startli"><b> Note </b> : In Windows, dslite.bat needs to be used instead of dslite.sh and during flashing if you get any error "Unknown response from the target", please disconnect UART cable and connect once again then try to flash. <b> Note </b> : In case of J7200 flash OSPI Phy Tuning bin file at location 3FC0000 and for J721E at 3FE0000.</p>
</li>
</ul>
<p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
 <h2><a class="anchor" id="demo_xip_fota_care_abouts"></a>
BIOS Care abouts to run on XIP mode</h2>
<p>Cache needs to be always ON and following BIOS setting change should be added in sysbios cfg file.</p>
<p>var Cache = xdc.useModule('ti.sysbios.family.arm.v7r.Cache');</p>
<p>Cache.skipEarlyCacheStartup = true;</p>
<p><a class="el" href="demo_xip_fota_profile_top.html">Back To Top</a></p>
<hr/>
 <h1><a class="anchor" id="demo_xip_fota_profile_rev_history"></a>
Document Revision History</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Revision  </th><th class="markdownTableHeadNone">Date  </th><th class="markdownTableHeadNone">Author  </th><th class="markdownTableHeadNone">Description  </th><th class="markdownTableHeadNone">Status   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0.1  </td><td class="markdownTableBodyNone">25 Jun 2021  </td><td class="markdownTableBodyNone">Aditya W  </td><td class="markdownTableBodyNone">Initial Version  </td><td class="markdownTableBodyNone">Under Review   </td></tr>
</table>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="demo_top.html">MCUSS Demo Applications</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
